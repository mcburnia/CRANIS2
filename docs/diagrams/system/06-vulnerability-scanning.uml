@startuml Vulnerability Scanning — System Level
title Vulnerability Scanning — System Process

participant "Scheduler" as sched
participant "Vuln DB Sync\n(1 AM)" as vdbsync
participant "Vuln Scanner\n(3 AM)" as scanner
participant "Notification\nService" as notif
database "Postgres" as pg
database "Neo4j" as neo
participant "OSV API\n(open source vulns)" as osv
participant "NVD API\n(NIST)" as nvd

== Phase 1: Vulnerability Database Sync (1 AM) ==

sched -> vdbsync : runDailyVulnDbSync()

vdbsync -> osv : GET /v1/vulns\n(paginated, since last sync)
osv --> vdbsync : Advisory list\n(CVE IDs, affected packages,\nversions, severity)

vdbsync -> pg : UPSERT vuln_db_advisories\nfor each advisory
pg --> vdbsync : Advisories stored

vdbsync -> nvd : GET /rest/json/cves/2.0\n(paginated, modified since last sync)
nvd --> vdbsync : CVE records with\nCPE matching data

vdbsync -> pg : UPSERT vuln_db_nvd\nand vuln_db_nvd_cpe_index
pg --> vdbsync : NVD data stored

vdbsync -> pg : UPDATE vuln_db_sync_status\nSET last_sync = NOW()
pg --> vdbsync : Sync timestamp updated

== Phase 2: Platform Vulnerability Scan (3 AM) ==

sched -> scanner : runDailyVulnScan()

scanner -> pg : INSERT INTO platform_scan_runs\n(started_at, status='running')
pg --> scanner : Scan run ID

loop For each product with SBOM

  scanner -> pg : SELECT dependencies\nFROM product_sboms\nWHERE product_id = ?
  pg --> scanner : Dependency list\n[{name, version}]

  loop For each dependency
    scanner -> pg : SELECT * FROM vuln_db_advisories\nWHERE affected_package = ?\nAND version_matches(?, affected_versions)
    pg --> scanner : Matching advisories

    scanner -> pg : SELECT * FROM vuln_db_nvd\nJOIN vuln_db_nvd_cpe_index\nWHERE cpe_product = ?
    pg --> scanner : Matching NVD entries
  end

  scanner -> scanner : Deduplicate findings\nNormalise severity\n(moderate → medium)

  scanner -> pg : UPSERT vulnerability_findings\n(product_id, cve_id, package_name,\nseverity, description, affected_version)
  pg --> scanner : Findings stored

  scanner -> neo : MERGE (v:Vulnerability {cveId})\nCREATE (p)-[:HAS_VULN]->(v)
  neo --> scanner : Graph updated

  scanner -> pg : UPDATE vulnerability_scans\nSET findings_count = ?\nWHERE product_id = ?
  pg --> scanner : Scan record updated

  == Notify on New Critical/High Findings ==

  alt New critical or high findings detected
    scanner -> notif : createNotification(\n  orgId, severity='critical',\n  title='New vulnerability found',\n  productId)
    notif -> pg : INSERT INTO notifications
    pg --> notif : Notification created
  end

end

scanner -> pg : UPDATE platform_scan_runs\nSET status='complete',\nfinished_at=NOW(),\nfindings_count=?
pg --> scanner : Scan run complete

@enduml
