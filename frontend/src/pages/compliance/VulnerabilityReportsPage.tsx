import { useState, useEffect } from 'react';
import { Link, useNavigate, useSearchParams } from 'react-router-dom';
import PageHeader from '../../components/PageHeader';
import StatCard from '../../components/StatCard';
import {
  Shield, AlertTriangle, Clock, CheckCircle2, FileText, Plus,
  ChevronRight, AlertCircle
} from 'lucide-react';
import './VulnerabilityReportsPage.css';

interface Report {
  id: string;
  productId: string;
  productName: string;
  reportType: 'vulnerability' | 'incident';
  status: string;
  awarenessAt: string | null;
  earlyWarningDeadline: string | null;
  notificationDeadline: string | null;
  finalReportDeadline: string | null;
  csirtCountry: string | null;
  memberStatesAffected: string[];
  sensitivityTlp: string;
  createdByEmail: string;
  stageCount: number;
  createdAt: string;
  updatedAt: string;
}

interface Overview {
  activeReports: number;
  draftCount: number;
  earlyWarningCount: number;
  notificationCount: number;
  finalReportCount: number;
  closedCount: number;
  vulnerabilityCount: number;
  incidentCount: number;
  overdueCount: number;
  reportsThisMonth: number;
  nextDeadline: { id: string; product_id: string; report_type: string; status: string; next_deadline: string } | null;
}

interface Product {
  id: string;
  name: string;
}

const STATUS_CONFIG: Record<string, { label: string; className: string; icon: typeof Shield }> = {
  draft: { label: 'Draft', className: 'vr-status-draft', icon: FileText },
  early_warning_sent: { label: 'Early Warning Sent', className: 'vr-status-early-warning', icon: AlertTriangle },
  notification_sent: { label: 'Notification Sent', className: 'vr-status-notification', icon: Clock },
  final_report_sent: { label: 'Final Report Sent', className: 'vr-status-final', icon: CheckCircle2 },
  closed: { label: 'Closed', className: 'vr-status-closed', icon: CheckCircle2 },
};

function getNextDeadline(report: Report): { label: string; deadline: string | null; isOverdue: boolean } {
  const now = new Date();

  if (report.status === 'draft' && report.earlyWarningDeadline) {
    const d = new Date(report.earlyWarningDeadline);
    return { label: 'Early Warning', deadline: report.earlyWarningDeadline, isOverdue: d < now };
  }
  if (report.status === 'early_warning_sent' && report.notificationDeadline) {
    const d = new Date(report.notificationDeadline);
    return { label: 'Full Notification', deadline: report.notificationDeadline, isOverdue: d < now };
  }
  if (report.status === 'notification_sent' && report.finalReportDeadline) {
    const d = new Date(report.finalReportDeadline);
    return { label: 'Final Report', deadline: report.finalReportDeadline, isOverdue: d < now };
  }

  return { label: '', deadline: null, isOverdue: false };
}

function formatCountdown(deadline: string): string {
  const now = new Date();
  const d = new Date(deadline);
  const diff = d.getTime() - now.getTime();

  if (diff < 0) {
    const overdue = Math.abs(diff);
    const hours = Math.floor(overdue / (1000 * 60 * 60));
    if (hours < 24) return `${hours}h overdue`;
    const days = Math.floor(hours / 24);
    return `${days}d overdue`;
  }

  const hours = Math.floor(diff / (1000 * 60 * 60));
  if (hours < 1) {
    const mins = Math.floor(diff / (1000 * 60));
    return `${mins}m remaining`;
  }
  if (hours < 24) return `${hours}h remaining`;
  const days = Math.floor(hours / 24);
  return `${days}d remaining`;
}

function formatDate(d: string | null): string {
  if (!d) return '—';
  return new Date(d).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

type StatusFilter = 'all' | 'active' | 'draft' | 'closed';

export default function VulnerabilityReportsPage() {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const [reports, setReports] = useState<Report[]>([]);
  const [overview, setOverview] = useState<Overview | null>(null);
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<StatusFilter>('all');
  const [showCreateModal, setShowCreateModal] = useState(false);

  // Create form state
  const [newProductId, setNewProductId] = useState('');
  const [newReportType, setNewReportType] = useState<'vulnerability' | 'incident'>('vulnerability');
  const [newAwarenessAt, setNewAwarenessAt] = useState('');
  const [creating, setCreating] = useState(false);

  const token = localStorage.getItem('session_token');
  const headers = { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' };

  useEffect(() => {
    fetchData();
  }, []);
  useEffect(() => { const c = searchParams.get("create"); const pid = searchParams.get("productId"); const fid = searchParams.get("findingId"); if (c === "true" && pid) { if (fid) { fetch("/api/cra-reports", { method: "POST", headers, body: JSON.stringify({ productId: pid, reportType: "vulnerability", awarenessAt: new Date().toISOString(), linkedFindingId: fid }) }).then(r => r.json()).then(data => { if (data.report) navigate("/vulnerability-reports/" + data.report.id); }).catch(() => {}); } else { setNewProductId(pid); setShowCreateModal(true); } } }, []);

  async function fetchData() {
    try {
      const [reportsRes, overviewRes] = await Promise.all([
        fetch('/api/cra-reports', { headers }),
        fetch('/api/cra-reports/overview', { headers }),
      ]);

      if (reportsRes.ok) {
        const data = await reportsRes.json();
        setReports(data.reports);
      }
      if (overviewRes.ok) {
        setOverview(await overviewRes.json());
      }

      // Fetch products for create modal
      const prodRes = await fetch('/api/products', { headers });
      if (prodRes.ok) {
        const prodData = await prodRes.json();
        setProducts(prodData.products || []);
      }
    } catch (err) {
      console.error('Failed to fetch CRA reports:', err);
    } finally {
      setLoading(false);
    }
  }

  async function handleCreate() {
    if (!newProductId) return;
    setCreating(true);
    try {
      const res = await fetch('/api/cra-reports', {
        method: 'POST',
        headers,
        body: JSON.stringify({
          productId: newProductId,
          reportType: newReportType,
          awarenessAt: newAwarenessAt || new Date().toISOString(),
        }),
      });
      if (res.ok) {
        const data = await res.json();
        navigate(`/vulnerability-reports/${data.report.id}`);
      }
    } catch (err) {
      console.error('Failed to create report:', err);
    } finally {
      setCreating(false);
    }
  }

  const filteredReports = reports.filter(r => {
    if (filter === 'all') return true;
    if (filter === 'active') return r.status !== 'closed' && r.status !== 'draft';
    if (filter === 'draft') return r.status === 'draft';
    if (filter === 'closed') return r.status === 'closed';
    return true;
  });

  if (loading) {
    return (
      <>
        <PageHeader title="ENISA Reporting" timestamp="CRA Article 14" />
        <p className="vr-empty">Loading reports...</p>
      </>
    );
  }

  return (
    <>
      <PageHeader title="ENISA Reporting" timestamp="CRA Article 14" />

      {/* Overview cards */}
      <div className="vr-stats">
        <StatCard label="Active Reports" value={overview?.activeReports || 0} color="blue" />
        <StatCard label="Overdue" value={overview?.overdueCount || 0} color="red" />
        <StatCard
          label="Next Deadline"
          value={overview?.nextDeadline ? formatCountdown(overview.nextDeadline.next_deadline) : 'None'}
          
          color="amber"
        />
        <StatCard label="This Month" value={overview?.reportsThisMonth || 0} color="green" />
      </div>

      {/* Article 14 info */}
      <div className="vr-info-banner">
        <Shield size={18} />
        <div>
          <strong>CRA Article 14 — Reporting Obligations</strong>
          <p>Manufacturers must report actively exploited vulnerabilities and severe incidents to their designated CSIRT and ENISA. Three-stage timeline: Early Warning (24h) → Full Notification (72h) → Final Report (14 days / 1 month).</p>
        </div>
      </div>

      {/* Actions row */}
      <div className="vr-actions">
        <div className="vr-filters">
          <button className={`vr-filter-btn ${filter === 'all' ? 'active' : ''}`} onClick={() => setFilter('all')}>
            All ({reports.length})
          </button>
          <button className={`vr-filter-btn ${filter === 'active' ? 'active' : ''}`} onClick={() => setFilter('active')}>
            Active ({reports.filter(r => r.status !== 'closed' && r.status !== 'draft').length})
          </button>
          <button className={`vr-filter-btn ${filter === 'draft' ? 'active' : ''}`} onClick={() => setFilter('draft')}>
            Drafts ({reports.filter(r => r.status === 'draft').length})
          </button>
          <button className={`vr-filter-btn ${filter === 'closed' ? 'active' : ''}`} onClick={() => setFilter('closed')}>
            Closed ({reports.filter(r => r.status === 'closed').length})
          </button>
        </div>
        <button className="vr-create-btn" onClick={() => setShowCreateModal(true)}>
          <Plus size={16} />
          New Report
        </button>
      </div>

      {/* Reports table */}
      {filteredReports.length === 0 ? (
        <div className="vr-empty-state">
          <Shield size={48} />
          <h3>No reports yet</h3>
          <p>When you identify an actively exploited vulnerability or severe incident, create a report to track your Article 14 notification obligations.</p>
          <button className="vr-create-btn" onClick={() => setShowCreateModal(true)}>
            <Plus size={16} /> Create First Report
          </button>
        </div>
      ) : (
        <div className="vr-table-wrapper">
          <table className="vr-table">
            <thead>
              <tr>
                <th>Product</th>
                <th>Type</th>
                <th>Status</th>
                <th>Next Deadline</th>
                <th>Countdown</th>
                <th>Created</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {filteredReports.map(report => {
                const { label: nextLabel, deadline, isOverdue } = getNextDeadline(report);
                const statusCfg = STATUS_CONFIG[report.status] || STATUS_CONFIG.draft;
                const StatusIcon = statusCfg.icon;

                return (
                  <tr key={report.id} className={isOverdue ? 'vr-row-overdue' : ''}>
                    <td>
                      <Link to={`/vulnerability-reports/${report.id}`} className="vr-product-link">
                        {report.productName}
                      </Link>
                    </td>
                    <td>
                      <span className={`vr-type-badge vr-type-${report.reportType}`}>
                        {report.reportType === 'vulnerability' ? 'Vulnerability' : 'Incident'}
                      </span>
                    </td>
                    <td>
                      <span className={`vr-status-badge ${statusCfg.className}`}>
                        <StatusIcon size={14} />
                        {statusCfg.label}
                      </span>
                    </td>
                    <td className="vr-deadline-label">{nextLabel || '—'}</td>
                    <td>
                      {deadline ? (
                        <span className={`vr-countdown ${isOverdue ? 'vr-overdue' : ''}`}>
                          {isOverdue && <AlertCircle size={14} />}
                          {formatCountdown(deadline)}
                        </span>
                      ) : '—'}
                    </td>
                    <td className="vr-date">{formatDate(report.createdAt)}</td>
                    <td>
                      <Link to={`/vulnerability-reports/${report.id}`} className="vr-row-action">
                        <ChevronRight size={16} />
                      </Link>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {/* Create Report Modal */}
      {showCreateModal && (
        <div className="vr-modal-overlay" onClick={() => setShowCreateModal(false)}>
          <div className="vr-modal" onClick={e => e.stopPropagation()}>
            <h3>New ENISA Report</h3>
            <p className="vr-modal-desc">Create an Article 14 notification report for an actively exploited vulnerability or severe incident.</p>

            <div className="vr-form-group">
              <label>Product</label>
              <select value={newProductId} onChange={e => setNewProductId(e.target.value)}>
                <option value="">Select a product...</option>
                {products.map(p => (
                  <option key={p.id} value={p.id}>{p.name}</option>
                ))}
              </select>
            </div>

            <div className="vr-form-group">
              <label>Report Type</label>
              <div className="vr-type-toggle">
                <button
                  className={`vr-type-opt ${newReportType === 'vulnerability' ? 'active' : ''}`}
                  onClick={() => setNewReportType('vulnerability')}
                >
                  <AlertTriangle size={16} />
                  Actively Exploited Vulnerability
                </button>
                <button
                  className={`vr-type-opt ${newReportType === 'incident' ? 'active' : ''}`}
                  onClick={() => setNewReportType('incident')}
                >
                  <Shield size={16} />
                  Severe Incident
                </button>
              </div>
            </div>

            <div className="vr-form-group">
              <label>When did you become aware?</label>
              <input
                type="datetime-local"
                value={newAwarenessAt}
                onChange={e => setNewAwarenessAt(e.target.value)}
              />
              <span className="vr-form-hint">This starts the 24h / 72h / 14d deadline clock</span>
            </div>

            <div className="vr-modal-actions">
              <button className="vr-btn-secondary" onClick={() => setShowCreateModal(false)}>Cancel</button>
              <button className="vr-btn-primary" onClick={handleCreate} disabled={!newProductId || creating}>
                {creating ? 'Creating...' : 'Create Report'}
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
}
